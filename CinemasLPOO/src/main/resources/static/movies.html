<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo de Filmes</title>
    <!-- Reaproveitamos os estilos do painel admin para manter o visual consistente -->
    <link rel="stylesheet" href="admin.css">
</head>
<body>
<header class="main-header">
    <h1>Catálogo de Filmes</h1>
    <!-- Se o usuário estiver logado como administrador (flag armazenada no localStorage), 
         mostramos um botão para voltar ao painel de administração -->
    <button id="back-admin" class="secondary-btn" style="display:none;">Painel Admin</button>
</header>

<main class="content">
    <!-- Seção de filtro por categoria -->
    <section class="filter-section">
        <label for="category-filter">Filtrar por categoria:</label>
        <select id="category-filter">
            <option value="">Todas</option>
        </select>
    </section>
    <!-- Grid de filmes -->
    <section class="list-section">
        <div id="movies-grid" class="movies-grid"></div>
    </section>
</main>

<script>
// Exibe botão de retorno ao painel admin se o usuário estiver logado
if (localStorage.getItem('loggedIn') === 'true') {
    const backBtn = document.getElementById('back-admin');
    backBtn.style.display = 'inline-block';
    backBtn.addEventListener('click', () => {
        window.location.href = 'admin.html';
    });
}

// Carrega todos os filmes e popula a lista e o select de categorias
async function loadAllMovies() {
    const res = await fetch('/api/movies');
    const movies = await res.json();
    populateCategories(movies);
    displayMovies(movies);
}

// Preenche o select com as categorias encontradas nos filmes
function populateCategories(movies) {
    const select = document.getElementById('category-filter');
    // extrai categorias únicas, mantendo a opção vazia como primeira
    const categories = [''];
    movies.forEach(m => {
        if (m.category && !categories.includes(m.category)) {
            categories.push(m.category);
        }
    });
    select.innerHTML = '';
    categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat || 'Todas';
        select.appendChild(option);
    });
}

// Renderiza o grid de filmes
function displayMovies(movies) {
    const grid = document.getElementById('movies-grid');
    grid.innerHTML = '';
    movies.forEach(movie => {
        const card = createMovieCard(movie);
        grid.appendChild(card);
    });
}

// Cria um card de filme com imagem, detalhes e formulários de edição
function createMovieCard(movie) {
    const card = document.createElement('div');
    card.className = 'movie-card';

    // Imagem do cartaz
    const img = document.createElement('img');
    img.src = movie.posterUrl || 'https://via.placeholder.com/200x300';
    img.alt = movie.title;
    card.appendChild(img);

    // Detalhes (título e categoria)
    const details = document.createElement('div');
    details.className = 'movie-details';
    const title = document.createElement('h3');
    title.textContent = movie.title;
    const category = document.createElement('p');
    category.textContent = 'Categoria: ' + movie.category;
    details.appendChild(title);
    details.appendChild(category);
    card.appendChild(details);

    // Ações (editar/excluir)
    const actions = document.createElement('div');
    actions.className = 'actions';
    const editBtn = document.createElement('button');
    editBtn.textContent = 'Editar';
    editBtn.className = 'secondary-btn';
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'Excluir';
    deleteBtn.className = 'danger-btn';
    actions.appendChild(editBtn);
    actions.appendChild(deleteBtn);
    card.appendChild(actions);

    // Formulário de edição (inicialmente oculto)
    const editForm = document.createElement('form');
    editForm.className = 'edit-form movie-form';
    editForm.style.display = 'none';
    editForm.enctype = 'multipart/form-data';
    editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(editForm);
        const res = await fetch(`/api/movies/${movie.id}`, {
            method: 'PUT',
            body: formData
        });
        if (res.ok) {
            // Recarrega os filmes de acordo com o filtro atual
            const currentCategory = document.getElementById('category-filter').value;
            await filterByCategory(currentCategory);
        } else {
            alert('Erro ao atualizar filme');
        }
    });
    // Campos do formulário de edição
    // Título
    const titleGroup = document.createElement('div');
    titleGroup.className = 'form-group';
    const titleLabel = document.createElement('label');
    titleLabel.textContent = 'Título';
    const titleInput = document.createElement('input');
    titleInput.type = 'text';
    titleInput.name = 'title';
    titleInput.value = movie.title;
    titleGroup.appendChild(titleLabel);
    titleGroup.appendChild(titleInput);
    // Categoria
    const catGroup = document.createElement('div');
    catGroup.className = 'form-group';
    const catLabel = document.createElement('label');
    catLabel.textContent = 'Categoria';
    const catInput = document.createElement('input');
    catInput.type = 'text';
    catInput.name = 'category';
    catInput.value = movie.category;
    catGroup.appendChild(catLabel);
    catGroup.appendChild(catInput);
    // Cartaz
    const posterGroup = document.createElement('div');
    posterGroup.className = 'form-group';
    const posterLabel = document.createElement('label');
    posterLabel.textContent = 'Cartaz';
    const posterInput = document.createElement('input');
    posterInput.type = 'file';
    posterInput.name = 'poster';
    posterInput.accept = 'image/*';
    posterGroup.appendChild(posterLabel);
    posterGroup.appendChild(posterInput);
    // Ações do form
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'edit-actions';
    const saveBtn = document.createElement('button');
    saveBtn.type = 'submit';
    saveBtn.className = 'primary-btn';
    saveBtn.textContent = 'Salvar';
    const cancelBtn = document.createElement('button');
    cancelBtn.type = 'button';
    cancelBtn.className = 'secondary-btn';
    cancelBtn.textContent = 'Cancelar';
    cancelBtn.addEventListener('click', () => {
        editForm.style.display = 'none';
    });
    buttonsDiv.appendChild(saveBtn);
    buttonsDiv.appendChild(cancelBtn);
    // Adiciona tudo ao formulário
    editForm.appendChild(titleGroup);
    editForm.appendChild(catGroup);
    editForm.appendChild(posterGroup);
    editForm.appendChild(buttonsDiv);

    // Alterna visibilidade do formulário
    editBtn.addEventListener('click', () => {
        editForm.style.display = editForm.style.display === 'none' ? 'block' : 'none';
    });
    // Exclui filme
    deleteBtn.addEventListener('click', () => deleteMovie(movie.id));

    card.appendChild(editForm);
    return card;
}

// Remove um filme e recarrega a lista
async function deleteMovie(id) {
    if (!confirm('Deseja realmente excluir este filme?')) return;
    const res = await fetch(`/api/movies/${id}`, { method: 'DELETE' });
    if (res.ok) {
        const currentCategory = document.getElementById('category-filter').value;
        await filterByCategory(currentCategory);
    } else {
        alert('Erro ao excluir filme');
    }
}

// Aplica o filtro por categoria e mostra apenas os filmes correspondentes
async function filterByCategory(category) {
    let url = '/api/movies';
    if (category) {
        url += '?category=' + encodeURIComponent(category);
    }
    const res = await fetch(url);
    const movies = await res.json();
    displayMovies(movies);
}

// Atualiza a lista ao mudar o select
document.getElementById('category-filter').addEventListener('change', async function() {
    const category = this.value;
    await filterByCategory(category);
});

// Inicia carregando todos os filmes
loadAllMovies();
</script>
</body>
</html>